<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>buffer.ml &mdash; Coverage report</title>
    <meta name="description" content="17.28% coverage in src/buffer/buffer.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/buffer/</span>buffer.ml
        </a>
      </h1>
      <h2>17.28%</h2>
    </div>
    <div id="navbar">
      <span class="some-visited" style="top:10.22%"></span>
      <span class="some-visited" style="top:10.47%"></span>
      <span class="some-visited" style="top:12.47%"></span>
      <span class="unvisited" style="top:13.97%"></span>
      <span class="unvisited" style="top:14.21%"></span>
      <span class="unvisited" style="top:14.46%"></span>
      <span class="unvisited" style="top:14.96%"></span>
      <span class="some-visited" style="top:16.46%"></span>
      <span class="unvisited" style="top:22.69%"></span>
      <span class="unvisited" style="top:23.19%"></span>
      <span class="unvisited" style="top:23.44%"></span>
      <span class="unvisited" style="top:31.42%"></span>
      <span class="unvisited" style="top:31.67%"></span>
      <span class="unvisited" style="top:31.92%"></span>
      <span class="unvisited" style="top:32.17%"></span>
      <span class="unvisited" style="top:32.42%"></span>
      <span class="unvisited" style="top:32.67%"></span>
      <span class="unvisited" style="top:33.42%"></span>
      <span class="unvisited" style="top:33.67%"></span>
      <span class="unvisited" style="top:33.92%"></span>
      <span class="unvisited" style="top:34.16%"></span>
      <span class="unvisited" style="top:34.41%"></span>
      <span class="unvisited" style="top:34.66%"></span>
      <span class="unvisited" style="top:35.41%"></span>
      <span class="unvisited" style="top:35.66%"></span>
      <span class="unvisited" style="top:35.91%"></span>
      <span class="unvisited" style="top:36.16%"></span>
      <span class="unvisited" style="top:36.41%"></span>
      <span class="unvisited" style="top:36.66%"></span>
      <span class="unvisited" style="top:37.41%"></span>
      <span class="unvisited" style="top:37.66%"></span>
      <span class="unvisited" style="top:37.91%"></span>
      <span class="unvisited" style="top:38.65%"></span>
      <span class="unvisited" style="top:39.15%"></span>
      <span class="unvisited" style="top:39.65%"></span>
      <span class="unvisited" style="top:40.65%"></span>
      <span class="unvisited" style="top:44.89%"></span>
      <span class="unvisited" style="top:45.89%"></span>
      <span class="unvisited" style="top:46.13%"></span>
      <span class="unvisited" style="top:46.38%"></span>
      <span class="unvisited" style="top:46.88%"></span>
      <span class="unvisited" style="top:47.13%"></span>
      <span class="unvisited" style="top:49.88%"></span>
      <span class="unvisited" style="bottom:49.88%"></span>
      <span class="unvisited" style="bottom:49.63%"></span>
      <span class="unvisited" style="bottom:48.63%"></span>
      <span class="unvisited" style="bottom:48.38%"></span>
      <span class="unvisited" style="bottom:48.13%"></span>
      <span class="unvisited" style="bottom:47.38%"></span>
      <span class="unvisited" style="bottom:47.13%"></span>
      <span class="unvisited" style="bottom:46.38%"></span>
      <span class="unvisited" style="bottom:45.64%"></span>
      <span class="unvisited" style="bottom:45.39%"></span>
      <span class="unvisited" style="bottom:43.39%"></span>
      <span class="unvisited" style="bottom:43.14%"></span>
      <span class="unvisited" style="bottom:42.89%"></span>
      <span class="unvisited" style="bottom:42.64%"></span>
      <span class="unvisited" style="bottom:42.39%"></span>
      <span class="unvisited" style="bottom:42.14%"></span>
      <span class="unvisited" style="bottom:41.90%"></span>
      <span class="unvisited" style="bottom:41.15%"></span>
      <span class="unvisited" style="bottom:40.90%"></span>
      <span class="unvisited" style="bottom:40.65%"></span>
      <span class="unvisited" style="bottom:40.40%"></span>
      <span class="unvisited" style="bottom:40.15%"></span>
      <span class="unvisited" style="bottom:39.90%"></span>
      <span class="unvisited" style="bottom:38.90%"></span>
      <span class="unvisited" style="bottom:38.65%"></span>
      <span class="unvisited" style="bottom:38.15%"></span>
      <span class="unvisited" style="bottom:37.66%"></span>
      <span class="unvisited" style="bottom:37.41%"></span>
      <span class="unvisited" style="bottom:36.91%"></span>
      <span class="unvisited" style="bottom:36.41%"></span>
      <span class="unvisited" style="bottom:35.16%"></span>
      <span class="unvisited" style="bottom:34.91%"></span>
      <span class="unvisited" style="bottom:34.66%"></span>
      <span class="unvisited" style="bottom:34.16%"></span>
      <span class="unvisited" style="bottom:33.92%"></span>
      <span class="unvisited" style="bottom:33.67%"></span>
      <span class="unvisited" style="bottom:33.42%"></span>
      <span class="unvisited" style="bottom:32.67%"></span>
      <span class="unvisited" style="bottom:32.42%"></span>
      <span class="unvisited" style="bottom:32.17%"></span>
      <span class="unvisited" style="bottom:31.92%"></span>
      <span class="unvisited" style="bottom:31.67%"></span>
      <span class="unvisited" style="bottom:31.42%"></span>
      <span class="unvisited" style="bottom:31.17%"></span>
      <span class="unvisited" style="bottom:30.67%"></span>
      <span class="unvisited" style="bottom:30.17%"></span>
      <span class="unvisited" style="bottom:29.68%"></span>
      <span class="some-visited" style="bottom:28.68%"></span>
      <span class="unvisited" style="bottom:28.43%"></span>
      <span class="unvisited" style="bottom:26.68%"></span>
      <span class="unvisited" style="bottom:26.18%"></span>
      <span class="unvisited" style="bottom:25.69%"></span>
      <span class="unvisited" style="bottom:25.44%"></span>
      <span class="unvisited" style="bottom:24.19%"></span>
      <span class="unvisited" style="bottom:23.69%"></span>
      <span class="unvisited" style="bottom:23.19%"></span>
      <span class="unvisited" style="bottom:22.94%"></span>
      <span class="unvisited" style="bottom:21.95%"></span>
      <span class="unvisited" style="bottom:21.20%"></span>
      <span class="unvisited" style="bottom:20.95%"></span>
      <span class="unvisited" style="bottom:20.70%"></span>
      <span class="unvisited" style="bottom:15.96%"></span>
      <span class="unvisited" style="bottom:15.21%"></span>
      <span class="unvisited" style="bottom:14.71%"></span>
      <span class="unvisited" style="bottom:14.21%"></span>
      <span class="unvisited" style="bottom:13.22%"></span>
      <span class="unvisited" style="bottom:12.47%"></span>
      <span class="unvisited" style="bottom:11.97%"></span>
      <span class="unvisited" style="bottom:11.47%"></span>
      <span class="unvisited" style="bottom:10.47%"></span>
      <span class="unvisited" style="bottom:9.73%"></span>
      <span class="unvisited" style="bottom:9.23%"></span>
      <span class="unvisited" style="bottom:8.73%"></span>
      <span class="unvisited" style="bottom:7.73%"></span>
      <span class="unvisited" style="bottom:6.98%"></span>
      <span class="unvisited" style="bottom:6.48%"></span>
      <span class="unvisited" style="bottom:5.99%"></span>
      <span class="unvisited" style="bottom:4.99%"></span>
      <span class="unvisited" style="bottom:4.24%"></span>
      <span class="unvisited" style="bottom:3.49%"></span>
      <span class="unvisited" style="bottom:2.74%"></span>
      <span class="unvisited" style="bottom:2.00%"></span>
      <span class="unvisited" style="bottom:1.25%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span class="some-visited"> </span>
<a id="L42"></a><span class="some-visited"> </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span class="visited"> </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span class="visited"> </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span class="some-visited"> </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span class="unvisited"> </span>
<a id="L57"></a><span class="unvisited"> </span>
<a id="L58"></a><span class="unvisited"> </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span class="unvisited"> </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span class="some-visited"> </span>
<a id="L67"></a><span class="visited"> </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span class="visited"> </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="visited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span class="visited"> </span>
<a id="L79"></a><span > </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span > </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="unvisited"> </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="unvisited"> </span>
<a id="L94"></a><span class="unvisited"> </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span class="visited"> </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span > </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span class="unvisited"> </span>
<a id="L127"></a><span class="unvisited"> </span>
<a id="L128"></a><span class="unvisited"> </span>
<a id="L129"></a><span class="unvisited"> </span>
<a id="L130"></a><span class="unvisited"> </span>
<a id="L131"></a><span class="unvisited"> </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span class="unvisited"> </span>
<a id="L135"></a><span class="unvisited"> </span>
<a id="L136"></a><span class="unvisited"> </span>
<a id="L137"></a><span class="unvisited"> </span>
<a id="L138"></a><span class="unvisited"> </span>
<a id="L139"></a><span class="unvisited"> </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span class="unvisited"> </span>
<a id="L143"></a><span class="unvisited"> </span>
<a id="L144"></a><span class="unvisited"> </span>
<a id="L145"></a><span class="unvisited"> </span>
<a id="L146"></a><span class="unvisited"> </span>
<a id="L147"></a><span class="unvisited"> </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span class="unvisited"> </span>
<a id="L151"></a><span class="unvisited"> </span>
<a id="L152"></a><span class="unvisited"> </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span > </span>
<a id="L155"></a><span class="unvisited"> </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span class="unvisited"> </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span class="unvisited"> </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span class="unvisited"> </span>
<a id="L164"></a><span > </span>
<a id="L165"></a><span > </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span class="visited"> </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span > </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span class="visited"> </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span > </span>
<a id="L180"></a><span class="unvisited"> </span>
<a id="L181"></a><span > </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span > </span>
<a id="L184"></a><span class="unvisited"> </span>
<a id="L185"></a><span class="unvisited"> </span>
<a id="L186"></a><span class="unvisited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span class="unvisited"> </span>
<a id="L189"></a><span class="unvisited"> </span>
<a id="L190"></a><span > </span>
<a id="L191"></a><span > </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span > </span>
<a id="L194"></a><span > </span>
<a id="L195"></a><span > </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span > </span>
<a id="L198"></a><span > </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span class="unvisited"> </span>
<a id="L201"></a><span class="unvisited"> </span>
<a id="L202"></a><span class="unvisited"> </span>
<a id="L203"></a><span > </span>
<a id="L204"></a><span > </span>
<a id="L205"></a><span > </span>
<a id="L206"></a><span class="unvisited"> </span>
<a id="L207"></a><span class="unvisited"> </span>
<a id="L208"></a><span class="unvisited"> </span>
<a id="L209"></a><span > </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span class="unvisited"> </span>
<a id="L212"></a><span class="unvisited"> </span>
<a id="L213"></a><span > </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span class="unvisited"> </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span class="unvisited"> </span>
<a id="L219"></a><span class="unvisited"> </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span > </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span > </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span > </span>
<a id="L227"></a><span class="unvisited"> </span>
<a id="L228"></a><span class="unvisited"> </span>
<a id="L229"></a><span class="unvisited"> </span>
<a id="L230"></a><span class="unvisited"> </span>
<a id="L231"></a><span class="unvisited"> </span>
<a id="L232"></a><span class="unvisited"> </span>
<a id="L233"></a><span class="unvisited"> </span>
<a id="L234"></a><span > </span>
<a id="L235"></a><span > </span>
<a id="L236"></a><span class="unvisited"> </span>
<a id="L237"></a><span class="unvisited"> </span>
<a id="L238"></a><span class="unvisited"> </span>
<a id="L239"></a><span class="unvisited"> </span>
<a id="L240"></a><span class="unvisited"> </span>
<a id="L241"></a><span class="unvisited"> </span>
<a id="L242"></a><span > </span>
<a id="L243"></a><span > </span>
<a id="L244"></a><span > </span>
<a id="L245"></a><span class="unvisited"> </span>
<a id="L246"></a><span class="unvisited"> </span>
<a id="L247"></a><span > </span>
<a id="L248"></a><span class="unvisited"> </span>
<a id="L249"></a><span > </span>
<a id="L250"></a><span class="unvisited"> </span>
<a id="L251"></a><span class="unvisited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span class="unvisited"> </span>
<a id="L254"></a><span > </span>
<a id="L255"></a><span class="unvisited"> </span>
<a id="L256"></a><span > </span>
<a id="L257"></a><span > </span>
<a id="L258"></a><span > </span>
<a id="L259"></a><span > </span>
<a id="L260"></a><span class="unvisited"> </span>
<a id="L261"></a><span class="unvisited"> </span>
<a id="L262"></a><span class="unvisited"> </span>
<a id="L263"></a><span > </span>
<a id="L264"></a><span class="unvisited"> </span>
<a id="L265"></a><span class="unvisited"> </span>
<a id="L266"></a><span class="unvisited"> </span>
<a id="L267"></a><span class="unvisited"> </span>
<a id="L268"></a><span > </span>
<a id="L269"></a><span > </span>
<a id="L270"></a><span class="unvisited"> </span>
<a id="L271"></a><span class="unvisited"> </span>
<a id="L272"></a><span class="unvisited"> </span>
<a id="L273"></a><span class="unvisited"> </span>
<a id="L274"></a><span class="unvisited"> </span>
<a id="L275"></a><span class="unvisited"> </span>
<a id="L276"></a><span class="unvisited"> </span>
<a id="L277"></a><span > </span>
<a id="L278"></a><span class="unvisited"> </span>
<a id="L279"></a><span > </span>
<a id="L280"></a><span class="unvisited"> </span>
<a id="L281"></a><span > </span>
<a id="L282"></a><span class="unvisited"> </span>
<a id="L283"></a><span > </span>
<a id="L284"></a><span > </span>
<a id="L285"></a><span > </span>
<a id="L286"></a><span class="some-visited"> </span>
<a id="L287"></a><span class="unvisited"> </span>
<a id="L288"></a><span > </span>
<a id="L289"></a><span class="visited"> </span>
<a id="L290"></a><span > </span>
<a id="L291"></a><span > </span>
<a id="L292"></a><span > </span>
<a id="L293"></a><span > </span>
<a id="L294"></a><span class="unvisited"> </span>
<a id="L295"></a><span > </span>
<a id="L296"></a><span class="unvisited"> </span>
<a id="L297"></a><span > </span>
<a id="L298"></a><span class="unvisited"> </span>
<a id="L299"></a><span class="unvisited"> </span>
<a id="L300"></a><span > </span>
<a id="L301"></a><span > </span>
<a id="L302"></a><span > </span>
<a id="L303"></a><span > </span>
<a id="L304"></a><span class="unvisited"> </span>
<a id="L305"></a><span > </span>
<a id="L306"></a><span class="unvisited"> </span>
<a id="L307"></a><span > </span>
<a id="L308"></a><span class="unvisited"> </span>
<a id="L309"></a><span class="unvisited"> </span>
<a id="L310"></a><span > </span>
<a id="L311"></a><span > </span>
<a id="L312"></a><span > </span>
<a id="L313"></a><span class="unvisited"> </span>
<a id="L314"></a><span > </span>
<a id="L315"></a><span > </span>
<a id="L316"></a><span class="unvisited"> </span>
<a id="L317"></a><span class="unvisited"> </span>
<a id="L318"></a><span class="unvisited"> </span>
<a id="L319"></a><span > </span>
<a id="L320"></a><span > </span>
<a id="L321"></a><span > </span>
<a id="L322"></a><span > </span>
<a id="L323"></a><span > </span>
<a id="L324"></a><span > </span>
<a id="L325"></a><span > </span>
<a id="L326"></a><span > </span>
<a id="L327"></a><span > </span>
<a id="L328"></a><span > </span>
<a id="L329"></a><span > </span>
<a id="L330"></a><span > </span>
<a id="L331"></a><span > </span>
<a id="L332"></a><span > </span>
<a id="L333"></a><span > </span>
<a id="L334"></a><span > </span>
<a id="L335"></a><span > </span>
<a id="L336"></a><span > </span>
<a id="L337"></a><span class="unvisited"> </span>
<a id="L338"></a><span > </span>
<a id="L339"></a><span > </span>
<a id="L340"></a><span class="unvisited"> </span>
<a id="L341"></a><span > </span>
<a id="L342"></a><span class="unvisited"> </span>
<a id="L343"></a><span > </span>
<a id="L344"></a><span class="unvisited"> </span>
<a id="L345"></a><span > </span>
<a id="L346"></a><span > </span>
<a id="L347"></a><span > </span>
<a id="L348"></a><span class="unvisited"> </span>
<a id="L349"></a><span > </span>
<a id="L350"></a><span > </span>
<a id="L351"></a><span class="unvisited"> </span>
<a id="L352"></a><span > </span>
<a id="L353"></a><span class="unvisited"> </span>
<a id="L354"></a><span > </span>
<a id="L355"></a><span class="unvisited"> </span>
<a id="L356"></a><span > </span>
<a id="L357"></a><span > </span>
<a id="L358"></a><span > </span>
<a id="L359"></a><span class="unvisited"> </span>
<a id="L360"></a><span > </span>
<a id="L361"></a><span > </span>
<a id="L362"></a><span class="unvisited"> </span>
<a id="L363"></a><span > </span>
<a id="L364"></a><span class="unvisited"> </span>
<a id="L365"></a><span > </span>
<a id="L366"></a><span class="unvisited"> </span>
<a id="L367"></a><span > </span>
<a id="L368"></a><span > </span>
<a id="L369"></a><span > </span>
<a id="L370"></a><span class="unvisited"> </span>
<a id="L371"></a><span > </span>
<a id="L372"></a><span > </span>
<a id="L373"></a><span class="unvisited"> </span>
<a id="L374"></a><span > </span>
<a id="L375"></a><span class="unvisited"> </span>
<a id="L376"></a><span > </span>
<a id="L377"></a><span class="unvisited"> </span>
<a id="L378"></a><span > </span>
<a id="L379"></a><span > </span>
<a id="L380"></a><span > </span>
<a id="L381"></a><span class="unvisited"> </span>
<a id="L382"></a><span > </span>
<a id="L383"></a><span > </span>
<a id="L384"></a><span class="unvisited"> </span>
<a id="L385"></a><span > </span>
<a id="L386"></a><span > </span>
<a id="L387"></a><span class="unvisited"> </span>
<a id="L388"></a><span > </span>
<a id="L389"></a><span > </span>
<a id="L390"></a><span class="unvisited"> </span>
<a id="L391"></a><span > </span>
<a id="L392"></a><span > </span>
<a id="L393"></a><span class="unvisited"> </span>
<a id="L394"></a><span > </span>
<a id="L395"></a><span > </span>
<a id="L396"></a><span class="unvisited"> </span>
<a id="L397"></a><span > </span>
<a id="L398"></a><span > </span>
<a id="L399"></a><span > </span>
<a id="L400"></a><span > </span>
<a id="L401"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
<a href="#L277">277</a>
<a href="#L278">278</a>
<a href="#L279">279</a>
<a href="#L280">280</a>
<a href="#L281">281</a>
<a href="#L282">282</a>
<a href="#L283">283</a>
<a href="#L284">284</a>
<a href="#L285">285</a>
<a href="#L286">286</a>
<a href="#L287">287</a>
<a href="#L288">288</a>
<a href="#L289">289</a>
<a href="#L290">290</a>
<a href="#L291">291</a>
<a href="#L292">292</a>
<a href="#L293">293</a>
<a href="#L294">294</a>
<a href="#L295">295</a>
<a href="#L296">296</a>
<a href="#L297">297</a>
<a href="#L298">298</a>
<a href="#L299">299</a>
<a href="#L300">300</a>
<a href="#L301">301</a>
<a href="#L302">302</a>
<a href="#L303">303</a>
<a href="#L304">304</a>
<a href="#L305">305</a>
<a href="#L306">306</a>
<a href="#L307">307</a>
<a href="#L308">308</a>
<a href="#L309">309</a>
<a href="#L310">310</a>
<a href="#L311">311</a>
<a href="#L312">312</a>
<a href="#L313">313</a>
<a href="#L314">314</a>
<a href="#L315">315</a>
<a href="#L316">316</a>
<a href="#L317">317</a>
<a href="#L318">318</a>
<a href="#L319">319</a>
<a href="#L320">320</a>
<a href="#L321">321</a>
<a href="#L322">322</a>
<a href="#L323">323</a>
<a href="#L324">324</a>
<a href="#L325">325</a>
<a href="#L326">326</a>
<a href="#L327">327</a>
<a href="#L328">328</a>
<a href="#L329">329</a>
<a href="#L330">330</a>
<a href="#L331">331</a>
<a href="#L332">332</a>
<a href="#L333">333</a>
<a href="#L334">334</a>
<a href="#L335">335</a>
<a href="#L336">336</a>
<a href="#L337">337</a>
<a href="#L338">338</a>
<a href="#L339">339</a>
<a href="#L340">340</a>
<a href="#L341">341</a>
<a href="#L342">342</a>
<a href="#L343">343</a>
<a href="#L344">344</a>
<a href="#L345">345</a>
<a href="#L346">346</a>
<a href="#L347">347</a>
<a href="#L348">348</a>
<a href="#L349">349</a>
<a href="#L350">350</a>
<a href="#L351">351</a>
<a href="#L352">352</a>
<a href="#L353">353</a>
<a href="#L354">354</a>
<a href="#L355">355</a>
<a href="#L356">356</a>
<a href="#L357">357</a>
<a href="#L358">358</a>
<a href="#L359">359</a>
<a href="#L360">360</a>
<a href="#L361">361</a>
<a href="#L362">362</a>
<a href="#L363">363</a>
<a href="#L364">364</a>
<a href="#L365">365</a>
<a href="#L366">366</a>
<a href="#L367">367</a>
<a href="#L368">368</a>
<a href="#L369">369</a>
<a href="#L370">370</a>
<a href="#L371">371</a>
<a href="#L372">372</a>
<a href="#L373">373</a>
<a href="#L374">374</a>
<a href="#L375">375</a>
<a href="#L376">376</a>
<a href="#L377">377</a>
<a href="#L378">378</a>
<a href="#L379">379</a>
<a href="#L380">380</a>
<a href="#L381">381</a>
<a href="#L382">382</a>
<a href="#L383">383</a>
<a href="#L384">384</a>
<a href="#L385">385</a>
<a href="#L386">386</a>
<a href="#L387">387</a>
<a href="#L388">388</a>
<a href="#L389">389</a>
<a href="#L390">390</a>
<a href="#L391">391</a>
<a href="#L392">392</a>
<a href="#L393">393</a>
<a href="#L394">394</a>
<a href="#L395">395</a>
<a href="#L396">396</a>
<a href="#L397">397</a>
<a href="#L398">398</a>
<a href="#L399">399</a>
<a href="#L400">400</a>
<a href="#L401">401</a>
</pre>
<pre><code class="ocaml">(**************************************************************************)
(*                                                                        *)
(*                                 OCaml                                  *)
(*                                                                        *)
(*    Pierre Weis and Xavier Leroy, projet Cristal, INRIA Rocquencourt    *)
(*                                                                        *)
(*   Copyright 1999 Institut National de Recherche en Informatique et     *)
(*     en Automatique.                                                    *)
(*                                                                        *)
(*   All rights reserved.  This file is distributed under the terms of    *)
(*   the GNU Lesser General Public License version 2.1, with the          *)
(*   special exception on linking described in the file LICENSE.          *)
(*                                                                        *)
(**************************************************************************)

(* Extensible buffers *)

(* The [inner_buffer] type ensures that the [length] and [buffer] fields are
   always synchronized, [length = Bytes.length buffer], even in presence
   of data races.
*)
type inner_buffer = {
  buffer: bytes;
  length: int;
}

type t =
 {mutable inner : inner_buffer;
  mutable position : int;
  initial_buffer : bytes}
(* Invariants: all parts of the code preserve the invariants that:
   - [inner.length = Bytes.length inner.buffer]
   In absence of data races, we also have
   - [0 &lt;= b.position &lt;= b.inner.length]

   Note in particular that [b.position = b.inner.length] is legal,
   it means that the buffer is full and will have to be extended
   before any further addition. *)

let create n =
 <span data-count="5030">l</span>et n = if n &lt; 1 then <span data-count="0">1</span> else <span data-count="5030">n</span> in
 let n = if n &gt; Sys.max_string_length then <span data-count="0">S</span>ys.max_string_length else <span data-count="5030">n</span> in
 let s = Bytes.create n in
 <span data-count="5030">{</span> inner = { buffer = s; length = n}; position = 0; initial_buffer = s}

let contents b = <span data-count="40716">B</span>ytes.sub_string b.inner.buffer 0 b.position
let to_bytes b = <span data-count="37529">B</span>ytes.sub b.inner.buffer 0 b.position

let sub b ofs len =
  <span data-count="37690">i</span>f ofs &lt; <span data-count="0">0</span> || len &lt; <span data-count="0">0</span> || ofs &gt; b.position - le<span data-count="30037">n</span>
  then <span data-count="30037">i</span>nvalid_arg "Buffer.sub"
  else <span data-count="7653">B</span>ytes.sub_string b.inner.buffer ofs len


let blit src srcoff dst dstoff len =
  <span data-count="0">i</span>f len &lt; <span data-count="0">0</span> || srcoff &lt; <span data-count="0">0</span> || srcoff &gt; src.position - le<span data-count="0">n</span>
             || dstoff &lt; <span data-count="0">0</span> || dstoff &gt; (Bytes.lengt<span data-count="0">h</span> dst) - le<span data-count="0">n</span>
  then <span data-count="0">i</span>nvalid_arg "Buffer.blit"
  else
    <span data-count="0">B</span>ytes.blit src.inner.buffer srcoff dst dstoff len


let nth b ofs =
  <span data-count="39508">l</span>et position = b.position in
  let {buffer;length} = b.inner in
  if ofs &lt; <span data-count="0">0</span> || ofs &gt;= positio<span data-count="26575">n</span> || position &gt; lengt<span data-count="35">h</span> then
   <span data-count="26610">i</span>nvalid_arg "Buffer.nth"
  else <span data-count="12898">B</span>ytes.unsafe_get buffer ofs


let length b = <span data-count="75382">b</span>.position

let clear b = <span data-count="40708">b</span>.position &lt;- 0

let reset b =
  <span data-count="43023">b</span>.position &lt;- 0;
  let inner =
    { buffer = b.initial_buffer; length = Bytes.lengt<span data-count="43023">h</span> b.initial_buffer }
  in
  b.inner &lt;- inner

(* [resize b more] ensures that [b.position + more &lt;= b.inner.length] holds
   by dynamically extending [b.inner] if necessary -- and thus
   increasing [b.inner.length].
*)
let resize b more =
  <span data-count="18376">l</span>et old_pos = b.position in
  let old_len = b.inner.length in
  let new_len = ref old_len in
  while old_pos + more &gt; !new_len do <span data-count="32757">n</span>ew_len := 2 * !new_len done;
  if !new_len &gt; Sys.max_string_length then <span data-count="0">b</span>egin
    if old_pos + more &lt;= Sys.max_string_length
    then <span data-count="0">n</span>ew_len := Sys.max_string_length
    else <span data-count="0">f</span>ailwith "Buffer.add: cannot grow buffer"
  end;
  <span data-count="18376">l</span>et new_buffer = Bytes.create !new_len in
  (* PR#6148: let's keep using [blit] rather than [unsafe_blit] in
     this tricky function that is slow anyway. *)
  <span data-count="18376">B</span>ytes.blit b.inner.buffer 0 new_buffer 0 b.position;
  <span data-count="18376">b</span>.inner &lt;- { buffer = new_buffer; length = !new_len }

(* Note:
    Some of the functions below have a fast path when the inner
  buffer doesn't need to be extended.
    In this case, it is possible to use unsafe accesses on the
  contents of the [inner] field since its fields are immutable.
  In presence of data races, we may access the wrong inner buffer, but we
  will use this buffer safely.
  As soon as we need to resize the buffer, we fall back to safe accesses.
*)

let add_char b c =
  <span data-count="37659">l</span>et pos = b.position in
  let {buffer;length} = b.inner in
  if pos &gt;= length then <span data-count="232">(</span>
    resize b 1;
    <span data-count="232">B</span>ytes.se<span data-count="232">t</span> b.inner.buffer b.position c
  ) else
    <span data-count="37427">B</span>ytes.unsafe_se<span data-count="37427">t</span> buffer pos c;
  b.position &lt;- pos + 1

let uchar_utf_8_byte_length_max = 4
let uchar_utf_16_byte_length_max = 4

let rec add_utf_8_uchar b u =
  <span data-count="0">l</span>et pos = b.position in
  if pos &gt;= b.inner.length then <span data-count="0">r</span>esiz<span data-count="0">e</span> b uchar_utf_8_byte_length_max;
  <span data-count="0">l</span>et n = Bytes.set_utf_8_uchar b.inner.buffer pos u in
  <span data-count="0">i</span>f n = 0
  then <span data-count="0">(</span>resize b uchar_utf_8_byte_length_max; <span data-count="0">a</span>dd_utf_8_uchar b u)
  else <span data-count="0">(</span>b.position &lt;- pos + n)

let rec add_utf_16be_uchar b u =
  <span data-count="0">l</span>et pos = b.position in
  if pos &gt;= b.inner.length then <span data-count="0">r</span>esiz<span data-count="0">e</span> b uchar_utf_16_byte_length_max;
  <span data-count="0">l</span>et n = Bytes.set_utf_16be_uchar b.inner.buffer pos u in
  <span data-count="0">i</span>f n = 0
  then <span data-count="0">(</span>resize b uchar_utf_16_byte_length_max; <span data-count="0">a</span>dd_utf_16be_uchar b u)
  else <span data-count="0">(</span>b.position &lt;- pos + n)

let rec add_utf_16le_uchar b u =
  <span data-count="0">l</span>et pos = b.position in
  if pos &gt;= b.inner.length then <span data-count="0">r</span>esiz<span data-count="0">e</span> b uchar_utf_16_byte_length_max;
  <span data-count="0">l</span>et n = Bytes.set_utf_16le_uchar b.inner.buffer pos u in
  <span data-count="0">i</span>f n = 0
  then <span data-count="0">(</span>resize b uchar_utf_16_byte_length_max; <span data-count="0">a</span>dd_utf_16le_uchar b u)
  else <span data-count="0">(</span>b.position &lt;- pos + n)

let add_substring b s offset len =
  <span data-count="0">i</span>f offset &lt; <span data-count="0">0</span> || len &lt; <span data-count="0">0</span> || offset &gt; String.lengt<span data-count="0">h</span> s - le<span data-count="0">n</span>
  then <span data-count="0">i</span>nvalid_ar<span data-count="0">g</span> "Buffer.add_substring/add_subbytes";
  <span data-count="0">l</span>et position = b.position in
  let {buffer;length} = b.inner in
  let new_position = position + len in
  if new_position &gt; length then <span data-count="0">(</span>
    resize b len;
    <span data-count="0">B</span>ytes.blit_strin<span data-count="0">g</span> s offset b.inner.buffer b.position len
  ) else
    <span data-count="0">B</span>ytes.unsafe_blit_strin<span data-count="0">g</span> s offset buffer position len;
  b.position &lt;- new_position

let add_subbytes b s offset len =
  <span data-count="0">a</span>dd_substring b (Bytes.unsafe_to_strin<span data-count="0">g</span> s) offset len

let add_string b s =
  <span data-count="82248">l</span>et len = String.length s in
  <span data-count="82248">l</span>et position = b.position in
  let {buffer; length} = b.inner in
  let new_position = b.position + len in
  if new_position &gt; length then <span data-count="18144">(</span>
    resize b len;
    <span data-count="18144">B</span>ytes.blit_strin<span data-count="18144">g</span> s 0 b.inner.buffer b.position len;
  ) else
    <span data-count="64104">B</span>ytes.unsafe_blit_strin<span data-count="64104">g</span> s 0 buffer position len;
  b.position &lt;- new_position

let add_bytes b s = <span data-count="44641">a</span>dd_string b (Bytes.unsafe_to_strin<span data-count="44641">g</span> s)

let add_buffer b bs =
  <span data-count="0">a</span>dd_subbytes b bs.inner.buffer 0 bs.position

(* this (private) function could move into the standard library *)
let really_input_up_to ic buf ofs len =
  <span data-count="0">l</span>et rec loop ic buf ~already_read ~ofs ~to_read =
    <span data-count="0">i</span>f to_read = 0 then <span data-count="0">a</span>lready_read
    else <span data-count="0">b</span>egin
      let r = input ic buf ofs to_read in
      <span data-count="0">i</span>f r = 0 then <span data-count="0">a</span>lready_read
      else <span data-count="0">b</span>egin
        let already_read = already_read + r in
        let ofs = ofs + r in
        let to_read = to_read - r in
        loop ic buf ~already_read ~ofs ~to_read
      end
    end
  in loop ic buf ~already_read:0 ~ofs ~to_read:len


let unsafe_add_channel_up_to b ic len =
  <span data-count="0">i</span>f b.position + len &gt; b.inner.length then <span data-count="0">r</span>esiz<span data-count="0">e</span> b len;
  <span data-count="0">l</span>et n = really_input_up_to ic b.inner.buffer b.position len in
  <span data-count="0">b</span>.position &lt;- b.position + n;
  n

let add_channel b ic len =
  <span data-count="0">i</span>f len &lt; <span data-count="0">0</span> || len &gt; Sys.max_string_lengt<span data-count="0">h</span> then   (* PR#5004 *)
    <span data-count="0">i</span>nvalid_ar<span data-count="0">g</span> "Buffer.add_channel";
  <span data-count="0">l</span>et n = unsafe_add_channel_up_to b ic len in
  (* It is intentional that a consumer catching End_of_file
     will see the data written (see #6719, #7136). *)
  <span data-count="0">i</span>f n &lt; len then <span data-count="0">r</span>aise End_of_file;
  <span data-count="0">(</span>)

let output_buffer oc b =
  <span data-count="0">o</span>utput oc b.inner.buffer 0 b.position

let closing = function
  | <span data-count="0">'</span>(' -&gt; ')'
  | <span data-count="0">'</span>{' -&gt; '}'
  | _ -&gt; assert false

(* opening and closing: open and close characters, typically ( and )
   k: balance of opening and closing chars
   s: the string where we are searching
   start: the index where we start the search. *)
let advance_to_closing opening closing k s start =
  <span data-count="0">l</span>et rec advance k i lim =
    <span data-count="0">i</span>f i &gt;= lim then <span data-count="0">r</span>aise Not_found else
    <span data-count="0">i</span>f s.[i] = opening then <span data-count="0">a</span>dvance (k + 1) (i + 1) lim else
    <span data-count="0">i</span>f s.[i] = closing then
      <span data-count="0">i</span>f k = 0 then <span data-count="0">i</span> else <span data-count="0">a</span>dvance (k - 1) (i + 1) lim
    else <span data-count="0">a</span>dvance k (i + 1) lim in
  advance k start (String.lengt<span data-count="0">h</span> s)

let advance_to_non_alpha s start =
  <span data-count="0">l</span>et rec advance i lim =
    <span data-count="0">i</span>f i &gt;= lim then <span data-count="0">l</span>im else
    <span data-count="0">m</span>atch s.[i] with
    | <span data-count="0">'</span>a' .. 'z' | <span data-count="0">'</span>A' .. 'Z' | <span data-count="0">'</span>0' .. '9' | <span data-count="0">'</span>_' -&gt; advance (i + 1) lim
    | <span data-count="0">_</span> -&gt; i in
  advance start (String.lengt<span data-count="0">h</span> s)

(* We are just at the beginning of an ident in s, starting at start. *)
let find_ident s start lim =
  <span data-count="0">i</span>f start &gt;= lim then <span data-count="0">r</span>aise Not_found else
  <span data-count="0">m</span>atch s.[start] with
  (* Parenthesized ident ? *)
  | <span data-count="0">'</span>(' | <span data-count="0">'</span>{' as c -&gt;
     let new_start = start + 1 in
     let stop = advance_to_closing c (closin<span data-count="0">g</span> c) 0 s new_start in
     <span data-count="0">S</span>tring.su<span data-count="0">b</span> s new_start (stop - start - 1), stop + 1
  (* Regular ident *)
  | <span data-count="0">_</span> -&gt;
     let stop = advance_to_non_alpha s (start + 1) in
     <span data-count="0">S</span>tring.su<span data-count="0">b</span> s start (stop - start), stop

(* Substitute $ident, $(ident), or ${ident} in s,
    according to the function mapping f. *)
let add_substitute b f s =
  <span data-count="0">l</span>et lim = String.length s in
  <span data-count="0">l</span>et rec subst previous i =
    <span data-count="0">i</span>f i &lt; lim then <span data-count="0">b</span>egin
      match s.[i] with
      | <span data-count="0">'</span>$' as current when previous = '\\' -&gt;
         <span data-count="0">a</span>dd_char b current;
         <span data-count="0">s</span>ubst ' ' (i + 1)
      | <span data-count="0">'</span>$' -&gt;
         let j = i + 1 in
         let ident, next_i = find_ident s j lim in
         <span data-count="0">a</span>dd_string b (<span data-count="0">f</span> ident);
         <span data-count="0">s</span>ubst ' ' next_i
      | <span data-count="0">c</span>urrent when previous == '\\' -&gt;
         <span data-count="0">a</span>dd_char b '\\';
         <span data-count="0">a</span>dd_char b current;
         <span data-count="0">s</span>ubst ' ' (i + 1)
      | <span data-count="0">'</span>\\' as current -&gt;
         subst current (i + 1)
      | <span data-count="0">c</span>urrent -&gt;
         add_char b current;
         <span data-count="0">s</span>ubst current (i + 1)
    end else
    <span data-count="0">i</span>f previous = '\\' then <span data-count="0">a</span>dd_char b previous in
  subst ' ' 0

let truncate b len =
    <span data-count="37911">i</span>f len &lt; <span data-count="0">0</span> || len &gt; lengt<span data-count="37911">h</span> <span data-count="0">b</span> then
      <span data-count="0">i</span>nvalid_arg "Buffer.truncate"
    else
      <span data-count="37911">b</span>.position &lt;- len

(** {1 Iterators} *)

let to_seq b =
  <span data-count="0">l</span>et rec aux i () =
    (* Note that b.position is not a constant and cannot be lifted out of aux *)
    <span data-count="0">i</span>f i &gt;= b.position then <span data-count="0">S</span>eq.Nil
    else
      <span data-count="0">l</span>et x = Bytes.get b.inner.buffer i in
      <span data-count="0">S</span>eq.Cons (x, au<span data-count="0">x</span> (i+1))
  in
  aux 0

let to_seqi b =
  <span data-count="0">l</span>et rec aux i () =
    (* Note that b.position is not a constant and cannot be lifted out of aux *)
    <span data-count="0">i</span>f i &gt;= b.position then <span data-count="0">S</span>eq.Nil
    else
      <span data-count="0">l</span>et x = Bytes.get b.inner.buffer i in
      <span data-count="0">S</span>eq.Cons ((i,x), au<span data-count="0">x</span> (i+1))
  in
  aux 0

let add_seq b seq = <span data-count="0">S</span>eq.iter (add_cha<span data-count="0">r</span> b) seq

let of_seq i =
  <span data-count="0">l</span>et b = create 32 in
  <span data-count="0">a</span>dd_seq b i;
  <span data-count="0">b</span>

(** {6 Binary encoding of integers} *)

external unsafe_set_int8 : bytes -&gt; int -&gt; int -&gt; unit = "%bytes_unsafe_set"
external unsafe_set_int16 : bytes -&gt; int -&gt; int -&gt; unit = "%caml_bytes_set16u"
external unsafe_set_int32 : bytes -&gt; int -&gt; int32 -&gt; unit = "%caml_bytes_set32u"
external unsafe_set_int64 : bytes -&gt; int -&gt; int64 -&gt; unit = "%caml_bytes_set64u"
external set_int8 : bytes -&gt; int -&gt; int -&gt; unit = "%bytes_safe_set"
external set_int16 : bytes -&gt; int -&gt; int -&gt; unit = "%caml_bytes_set16"
external set_int32 : bytes -&gt; int -&gt; int32 -&gt; unit = "%caml_bytes_set32"
external set_int64 : bytes -&gt; int -&gt; int64 -&gt; unit = "%caml_bytes_set64"

external swap16 : int -&gt; int = "%bswap16"
external swap32 : int32 -&gt; int32 = "%bswap_int32"
external swap64 : int64 -&gt; int64 = "%bswap_int64"


let add_int8 b x =
  <span data-count="0">l</span>et position = b.position in
  let {length; buffer} = b.inner in
  let new_position = position + 1 in
  if new_position &gt; length then <span data-count="0">(</span>
    resize b 1;
    <span data-count="0">s</span>et_int<span data-count="0">8</span> b.inner.buffer b.position x
  ) else
    <span data-count="0">u</span>nsafe_set_int<span data-count="0">8</span> buffer position x;
  b.position &lt;- new_position

let add_int16_ne b x =
  <span data-count="0">l</span>et position = b.position in
  let {length; buffer} = b.inner in
  let new_position = position + 2 in
  if new_position &gt; length then <span data-count="0">(</span>
    resize b 2;
    <span data-count="0">s</span>et_int1<span data-count="0">6</span> b.inner.buffer b.position x
  ) else
    <span data-count="0">u</span>nsafe_set_int1<span data-count="0">6</span> buffer position x;
  b.position &lt;- new_position

let add_int32_ne b x =
  <span data-count="0">l</span>et position = b.position in
  let {length; buffer} = b.inner in
  let new_position = position + 4 in
  if new_position &gt; length then <span data-count="0">(</span>
    resize b 4;
    <span data-count="0">s</span>et_int3<span data-count="0">2</span> b.inner.buffer b.position x
  ) else
    <span data-count="0">u</span>nsafe_set_int3<span data-count="0">2</span> buffer position x;
  b.position &lt;- new_position

let add_int64_ne b x =
  <span data-count="0">l</span>et position = b.position in
  let {length; buffer} = b.inner in
  let new_position = position + 8 in
  if new_position &gt; length then <span data-count="0">(</span>
    resize b 8;
    <span data-count="0">s</span>et_int6<span data-count="0">4</span> b.inner.buffer b.position x
  ) else
    <span data-count="0">u</span>nsafe_set_int6<span data-count="0">4</span> buffer position x;
  b.position &lt;- new_position

let add_int16_le b x =
  <span data-count="0">a</span>dd_int16_ne b (if Sys.big_endian then <span data-count="0">s</span>wap1<span data-count="0">6</span> x else <span data-count="0">x</span>)

let add_int16_be b x =
  <span data-count="0">a</span>dd_int16_ne b (if Sys.big_endian then <span data-count="0">x</span> else <span data-count="0">s</span>wap1<span data-count="0">6</span> x)

let add_int32_le b x =
  <span data-count="0">a</span>dd_int32_ne b (if Sys.big_endian then <span data-count="0">s</span>wap3<span data-count="0">2</span> x else <span data-count="0">x</span>)

let add_int32_be b x =
  <span data-count="0">a</span>dd_int32_ne b (if Sys.big_endian then <span data-count="0">x</span> else <span data-count="0">s</span>wap3<span data-count="0">2</span> x)

let add_int64_le b x =
  <span data-count="0">a</span>dd_int64_ne b (if Sys.big_endian then <span data-count="0">s</span>wap6<span data-count="0">4</span> x else <span data-count="0">x</span>)

let add_int64_be b x =
  <span data-count="0">a</span>dd_int64_ne b (if Sys.big_endian then <span data-count="0">x</span> else <span data-count="0">s</span>wap6<span data-count="0">4</span> x)

let add_uint8 = add_int8
let add_uint16_ne = add_int16_ne
let add_uint16_le = add_int16_le
let add_uint16_be = add_int16_be
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
