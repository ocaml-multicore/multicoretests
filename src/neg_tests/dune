;; Negative tests to confirm that approach works

(library
 (name stm_tests_spec_ref)
 (modules stm_tests_spec_ref)
 (package multicoretests)
 (libraries qcheck qcheck-stm.stm)
 (preprocess (pps ppx_deriving.show ppx_deriving.eq))
)

(test
 (name stm_tests_sequential_ref)
 (modules stm_tests_sequential_ref)
 (package multicoretests)
 (libraries stm_tests_spec_ref qcheck-stm.sequential)
 (action (run %{test} --verbose))
)

(test
 (name stm_tests_domain_ref)
 (modules stm_tests_domain_ref)
 (package multicoretests)
 (libraries stm_tests_spec_ref qcheck-stm.domain)
 (action (run %{test} --verbose))
)

(test
 (name stm_tests_thread_ref)
 (modules stm_tests_thread_ref)
 (package multicoretests)
 (libraries stm_tests_spec_ref qcheck-stm.thread)
 (action (run %{test} --verbose))
)

(library
 (name CList)
 (modules CList)
 (package multicoretests)
)

(test
 (name stm_tests_conclist)
 (modules stm_tests_conclist)
 (package multicoretests)
 (libraries CList qcheck-stm.sequential qcheck-stm.domain)
 (preprocess (pps ppx_deriving.show))
 (action (run %{test} --verbose))
)

;; Linearization tests of ref and Clist with Lin

(library
 (name lin_tests_dsl_common)
 (modules lin_tests_dsl_common)
 (package multicoretests)
 (libraries CList qcheck-lin.domain)
)

(library
 (name lin_tests_common)
 (modules lin_tests_common)
 (package multicoretests)
 (libraries CList qcheck-lin.domain)
 (preprocess (pps ppx_deriving_qcheck ppx_deriving.show ppx_deriving.eq))
)

(test
 (name lin_tests_dsl_domain)
 (modules lin_tests_dsl_domain)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_dsl_common)
 (action (run %{test} --verbose))
)

(test
 (name lin_tests_dsl_thread)
 (modules lin_tests_dsl_thread)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_dsl_common qcheck-lin.thread)
 ; (action (run %{test} --verbose))
 (action (echo "Skipping src/neg_tests/%{test} from the test suite\n\n"))
)

(test
 (name lin_tests_dsl_effect)
 (modules lin_tests_dsl_effect)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_dsl_common qcheck-lin.effect)
 (action (run %{test} --verbose))
)

;; Linearization tests of ref and Clist with Lin.Internal

(test
 (name lin_tests_domain)
 (modules lin_tests_domain)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_common)
  ; (action (run %{test} --verbose))
 (action (echo "Skipping src/neg_tests/%{test} from the test suite\n\n"))
)

(tests
 (names lin_tests_thread_ref lin_tests_thread_conclist)
 (modules lin_tests_thread_ref lin_tests_thread_conclist)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_common qcheck-lin.thread)
 (action (run %{test} --verbose))
)

(test
 (name lin_tests_effect)
 (modules lin_tests_effect)
 (package multicoretests)
 (flags (:standard -w -27))
 (libraries lin_tests_common qcheck-lin.effect)
 (preprocess (pps ppx_deriving.show ppx_deriving.eq))
  ; (action (run ./%{deps} --verbose))
 (action (echo "Skipping src/neg_tests/%{test} from the test suite\n\n"))
)
